<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Flutter &#43; Rust 跨平台应用开发 | YPLAM</title>
<meta name="keywords" content="Rust, Flutter">
<meta name="description" content="针对常规的网络应用型APP，Flutter &#43; Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter &#43; Rust 则是另一个可选项。">
<meta name="author" content="">
<link rel="canonical" href="https://yplam.com/posts/rust/flutter-rust/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e9646c1d4a681ebbffe4c0f5bdd79d96646d99daf08cf8a3488605487f2ba1.css" integrity="sha256-RelkbB1KaB67/&#43;TA9b3XnZZkbZna8Iz4o0iGBUh/K6E=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://yplam.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yplam.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yplam.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yplam.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://yplam.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://yplam.com/posts/rust/flutter-rust/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-960JLZS3KY"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-960JLZS3KY');
        }
      </script><meta property="og:url" content="https://yplam.com/posts/rust/flutter-rust/">
  <meta property="og:site_name" content="YPLAM">
  <meta property="og:title" content="Flutter &#43; Rust 跨平台应用开发">
  <meta property="og:description" content="针对常规的网络应用型APP，Flutter &#43; Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter &#43; Rust 则是另一个可选项。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-14T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-14T00:00:00+00:00">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Flutter">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flutter &#43; Rust 跨平台应用开发">
<meta name="twitter:description" content="针对常规的网络应用型APP，Flutter &#43; Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter &#43; Rust 则是另一个可选项。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yplam.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Flutter + Rust 跨平台应用开发",
      "item": "https://yplam.com/posts/rust/flutter-rust/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Flutter + Rust 跨平台应用开发",
  "name": "Flutter \u002b Rust 跨平台应用开发",
  "description": "针对常规的网络应用型APP，Flutter + Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter + Rust 则是另一个可选项。\n",
  "keywords": [
    "Rust", "Flutter"
  ],
  "articleBody": "针对常规的网络应用型APP，Flutter + Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter + Rust 则是另一个可选项。\nFlutter + Rust 最直接的方式可能是使用 Flutter Favorite 的库 flutter_rust_bridge，基于代码模板以及提供多个工具简化整个对接流程。然而，对于一些只需要导出少量 rust 接口的功能，使用 flutter_rust_bridge 未免引入了过多复杂性，而直接使用 dart ffi 反而是一个相对精简的实现。\nRust \u003c-\u003e C 配置 Cargo.toml 输出 C 库\n[package] name = \"xxx\" version = \"0.1.0\" edition = \"2024\" [lib] name = \"xxx\" crate-type = [\"cdylib\", \"rlib\"] 基于 cbindgen 导出 .h 头文件，创建 cbindgen.toml:\nlanguage = \"C\" header = \"/* Auto-generated by cbindgen */\" include_version = true braces = \"SameLine\" line_length = 100 tab_width = 4 documentation = true documentation_style = \"doxy\" [export] include = [\"xxx\"] exclude = [] [fn] rename_args = \"GeckoCase\" args = \"auto\" sort_by = \"Name\" [struct] rename_fields = \"ScreamingSnakeCase\" must_use = \"/*must_use*/\" derive_const_casts = true derive_mut_casts = true [enum] rename_variants = \"ScreamingSnakeCase\" must_use = \"/*must_use*/\" [const] allow_static_const = true allow_constexpr = false [macro_expansion] bitflags = true 然后更新 build.rs 编译脚本\nuse std::env; use std::path::PathBuf; fn main() { let crate_dir = env::var(\"CARGO_MANIFEST_DIR\").unwrap(); let output_dir = PathBuf::from(\u0026crate_dir); // Generate the header file cbindgen::Builder::new() .with_crate(crate_dir.clone()) .with_language(cbindgen::Language::C) .generate() .expect(\"Unable to generate bindings\") .write_to_file(output_dir.join(\"bindings.h\")); // Rerun if any of these change println!(\"cargo:rerun-if-changed=src/dart\"); println!(\"cargo:rerun-if-changed=cbindgen.toml\"); } 需要导出的Rust函数添加 #[unsafe(no_mangle)] 与 extern \"C\"，譬如，需要与 dart 对接必须要实现以下函数，接收 api_data 然后调用 Dart_InitializeApiDL 初始化，另外，Rust 到 Dart 的异步通讯可通过 dart_port 的方式实现：\n#[unsafe(no_mangle)] pub extern \"C\" fn initialize_dart_api(api_data: *mut ::core::ffi::c_void, dart_port: i64, is_debug: bool) { println!(\"Initializing Dart API\"); unsafe { if Dart_InitializeApiDL(api_data) != 0 { panic!(\"failed to initialize Dart DL C API: version mismatch. must update include/ to match Dart SDK version\"); } } // Store the dart port globally if let Ok(mut port) = DART_PORT.lock() { *port = Some(dart_port); } // Try to initialize logger, but don't panic if it's already initialized let log_level = if is_debug { \"debug\" } else { \"info\" }; let _ = env_logger::try_init_from_env(Env::default().default_filter_or(log_level)); info!(\"Dart API initialized with port: {}\", dart_port); } 这样打包Rust动态库的同时就会输出对应的头文件，譬如以上函数的定义：\nvoid initialize_dart_api(void *api_data, int64_t dart_port, bool is_debug); dart \u003c-\u003e C dart 根据 C 头文件与动态库，通过 ffi 的形式交互\ndart run ffigen --config ffigen.yaml 其中 ffigen.yaml:\n# Run with `dart run ffigen --config ffigen.yaml`. name: XXXBindings description: | Bindings for `bindings.h`. Regenerate bindings with `dart run ffigen --config ffigen.yaml`. output: 'lib/generated/xxx_bindings_generated.dart' headers: entry-points: - '../core/bindings.h' include-directives: - '../core/bindings.h' compiler-opts: - '-I/usr/lib/clang/20/include/' - '-I/usr/lib/clang/19/include/' preamble: | // ignore_for_file: always_specify_types // ignore_for_file: camel_case_types // ignore_for_file: non_constant_identifier_names comments: style: any length: full 运行后输出 xxx_bindings_generated.dart 为 dart 下的绑定，如下：\nvoid initialize_dart_api( ffi.Pointer\u003cffi.Void\u003e api_data, int dart_port, bool is_debug, ) { return _initialize_dart_api(api_data, dart_port, is_debug); } late final _initialize_dart_apiPtr = _lookup\u003c ffi.NativeFunction\u003c ffi.Void Function(ffi.Pointer\u003cffi.Void\u003e, ffi.Int64, ffi.Bool) \u003e \u003e('initialize_dart_api'); late final _initialize_dart_api = _initialize_dart_apiPtr .asFunction\u003cvoid Function(ffi.Pointer\u003cffi.Void\u003e, int, bool)\u003e(); 使用时需要增加动态库加载功能，并且最好是增加一个wapper类封装，类似 Rust 常用的 unsafe 机制。\n动态库加载：\nfinal dartffi.DynamicLibrary _dylib = () { if (Platform.isMacOS || Platform.isIOS) { return dartffi.DynamicLibrary.open('$_libName.framework/$_libName'); } if (Platform.isAndroid || Platform.isLinux) { return dartffi.DynamicLibrary.open('lib$_libName.so'); } if (Platform.isWindows) { return dartffi.DynamicLibrary.open('$_libName.dll'); } throw UnsupportedError('Unknown platform: ${Platform.operatingSystem}'); }(); wapper类实例化时必须先调用 initialize_dart_api 函数，譬如一个简单的实现, 启动时传入 _receivePort.sendPort.nativePort，然后通过监听 _receivePort 将 Rust 的异步消息以Stream的方式广播出去。\nfinal XXXBindings _xxxBindings = XXXBindings(_dylib); StreamController\u003cMessage\u003e? _messageController; static XXXService get instance { _instance ??= XXXService._internal(); return _instance!; } XXXService._internal() { _receivePort = ReceivePort(); _messageController = StreamController\u003cMessage\u003e.broadcast(); _engineStartedController!.add(false); // Initialize the Dart API in the native library _xxxBindings.initialize_dart_api( dartffi .NativeApi .initializeApiDLData, // API data - pass null from Dart side _receivePort.sendPort.nativePort, // Native port ID kDebugMode, // Debug mode flag ); // Start listening to the receive port _startListening(); } void _startListening() { _receivePort.listen( (rawMessage) { if (_disposed || _messageController == null) return; try { if (rawMessage is Uint8List) { final fbMessage = fb.Message(rawMessage); final message = Message.fromFlatBuffer(fbMessage); // logInfo('Received message'); _messageController!.add(message); } else { logWarning( 'Received unexpected message type: ${rawMessage.runtimeType}', ); } } catch (e, stackTrace) { logWarning('Error processing message: $e'); logWarning('Stack trace: $stackTrace'); // Add error to stream instead of silently ignoring _messageController!.addError(e, stackTrace); } }, onError: (error, stackTrace) { logWarning('ReceivePort error: $error'); logWarning('Stack trace: $stackTrace'); _messageController?.addError(error, stackTrace); }, onDone: () { logInfo('ReceivePort closed'); _messageController?.close(); }, ); } 内存管理 需要注意的是 Rust 下面申请的内存只能 Rust 下释放，Dart 亦同理。\n譬如，如果Rust以如下方式返回 CString：\nCString::new(xxx_string) .map(|c_string| c_string.into_raw()) .unwrap_or(std::ptr::null_mut()) 则需要提供一个接口到 dart，使该字符串使用后能释放：\n#[unsafe(no_mangle)] pub extern \"C\" fn free_string(ptr: *mut c_char) { if !ptr.is_null() { unsafe { let _ = CString::from_raw(ptr); } } } 对于 dart 申请的内存，也可以使用类似的机制 ：\nfinal dataPtr = malloc.allocate\u003cdartffi.Uint8\u003e(...) try { // ... } finally { malloc.free(dataPtr); } ",
  "wordCount" : "661",
  "inLanguage": "zh-cn",
  "datePublished": "2024-12-14T00:00:00Z",
  "dateModified": "2024-12-14T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yplam.com/posts/rust/flutter-rust/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "YPLAM",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yplam.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yplam.com/" title="YPLAM">
                    <span>HOME</span>

                </a>
            </li>
            <li>
                <a href="https://yplam.com/about/" title="关于YPLam">
                    <span>ABOUT</span>

                </a>
            </li>
            <li>
                <a href="https://github.com/yplam" title="GITHUB">
                    <span>GITHUB</span>

                </a>
            </li>
            <li>
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Flutter &#43; Rust 跨平台应用开发
    </h1>
    <div class="post-meta"><span title='2024-12-14 00:00:00 +0000 UTC'>2024-12-14</span>

</div>
  </header> 
  <div class="post-content"><p>针对常规的网络应用型APP，Flutter + Go 可以很好的兼顾性能与开发效率，而对于某些需要极致控制内存占用，需要与C库进行高效交互的程序，Flutter + Rust 则是另一个可选项。</p>
<p>Flutter + Rust 最直接的方式可能是使用 Flutter Favorite 的库 flutter_rust_bridge，基于代码模板以及提供多个工具简化整个对接流程。然而，对于一些只需要导出少量 rust 接口的功能，使用 flutter_rust_bridge 未免引入了过多复杂性，而直接使用 dart ffi 反而是一个相对精简的实现。</p>
<h2 id="rust---c">Rust &lt;-&gt; C<a hidden class="anchor" aria-hidden="true" href="#rust---c">#</a></h2>
<p>配置 Cargo.toml 输出 C 库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;xxx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">edition</span> <span class="p">=</span> <span class="s2">&#34;2024&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">lib</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;xxx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">crate-type</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;cdylib&#34;</span><span class="p">,</span> <span class="s2">&#34;rlib&#34;</span><span class="p">]</span>
</span></span></code></pre></div><p>基于 cbindgen 导出 .h 头文件，创建 cbindgen.toml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="nx">language</span> <span class="p">=</span> <span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">header</span> <span class="p">=</span> <span class="s2">&#34;/* Auto-generated by cbindgen */&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">include_version</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">braces</span> <span class="p">=</span> <span class="s2">&#34;SameLine&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">line_length</span> <span class="p">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="nx">tab_width</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nx">documentation</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">documentation_style</span> <span class="p">=</span> <span class="s2">&#34;doxy&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">export</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">include</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;xxx&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">exclude</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">fn</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">rename_args</span> <span class="p">=</span> <span class="s2">&#34;GeckoCase&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">args</span> <span class="p">=</span> <span class="s2">&#34;auto&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">sort_by</span> <span class="p">=</span> <span class="s2">&#34;Name&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">struct</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">rename_fields</span> <span class="p">=</span> <span class="s2">&#34;ScreamingSnakeCase&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">must_use</span> <span class="p">=</span> <span class="s2">&#34;/*must_use*/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">derive_const_casts</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">derive_mut_casts</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">enum</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">rename_variants</span> <span class="p">=</span> <span class="s2">&#34;ScreamingSnakeCase&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">must_use</span> <span class="p">=</span> <span class="s2">&#34;/*must_use*/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">const</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">allow_static_const</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">allow_constexpr</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">macro_expansion</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">bitflags</span> <span class="p">=</span> <span class="kc">true</span> 
</span></span></code></pre></div><p>然后更新 build.rs 编译脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">path</span>::<span class="n">PathBuf</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">crate_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&#34;CARGO_MANIFEST_DIR&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">output_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PathBuf</span>::<span class="n">from</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crate_dir</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Generate the header file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">cbindgen</span>::<span class="n">Builder</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">with_crate</span><span class="p">(</span><span class="n">crate_dir</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">with_language</span><span class="p">(</span><span class="n">cbindgen</span>::<span class="n">Language</span>::<span class="n">C</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">generate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Unable to generate bindings&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">output_dir</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#34;bindings.h&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Rerun if any of these change
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;cargo:rerun-if-changed=src/dart&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;cargo:rerun-if-changed=cbindgen.toml&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> 
</span></span></span></code></pre></div><p>需要导出的Rust函数添加 <code>#[unsafe(no_mangle)]</code> 与 <code>extern &quot;C&quot;</code>，譬如，需要与 dart 对接必须要实现以下函数，接收 api_data 然后调用 Dart_InitializeApiDL 初始化，另外，Rust 到 Dart 的异步通讯可通过 dart_port 的方式实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[unsafe(no_mangle)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&#34;C&#34;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">initialize_dart_api</span><span class="p">(</span><span class="n">api_data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">ffi</span>::<span class="n">c_void</span><span class="p">,</span><span class="w"> </span><span class="n">dart_port</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">is_debug</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Initializing Dart API&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">Dart_InitializeApiDL</span><span class="p">(</span><span class="n">api_data</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;failed to initialize Dart DL C API: version mismatch. must update include/ to match Dart SDK version&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Store the dart port globally
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">DART_PORT</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">*</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">dart_port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Try to initialize logger, but don&#39;t panic if it&#39;s already initialized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">is_debug</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&#34;debug&#34;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&#34;info&#34;</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env_logger</span>::<span class="n">try_init_from_env</span><span class="p">(</span><span class="n">Env</span>::<span class="n">default</span><span class="p">().</span><span class="n">default_filter_or</span><span class="p">(</span><span class="n">log_level</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">info!</span><span class="p">(</span><span class="s">&#34;Dart API initialized with port: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">dart_port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这样打包Rust动态库的同时就会输出对应的头文件，譬如以上函数的定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initialize_dart_api</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">api_data</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">dart_port</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_debug</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="dart---c">dart &lt;-&gt; C<a hidden class="anchor" aria-hidden="true" href="#dart---c">#</a></h2>
<p>dart 根据 C 头文件与动态库，通过 ffi 的形式交互</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">dart run ffigen --config ffigen.yaml
</span></span></code></pre></div><p>其中 ffigen.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Run with `dart run ffigen --config ffigen.yaml`.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">XXXBindings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">  Bindings for `bindings.h`.
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">  Regenerate bindings with `dart run ffigen --config ffigen.yaml`.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;lib/generated/xxx_bindings_generated.dart&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entry-points</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s1">&#39;../core/bindings.h&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">include-directives</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s1">&#39;../core/bindings.h&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">compiler-opts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s1">&#39;-I/usr/lib/clang/20/include/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s1">&#39;-I/usr/lib/clang/19/include/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">preamble</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">  // ignore_for_file: always_specify_types
</span></span></span><span class="line"><span class="cl"><span class="sd">  // ignore_for_file: camel_case_types
</span></span></span><span class="line"><span class="cl"><span class="sd">  // ignore_for_file: non_constant_identifier_names</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">comments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">style</span><span class="p">:</span><span class="w"> </span><span class="l">any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">length</span><span class="p">:</span><span class="w"> </span><span class="l">full</span><span class="w">
</span></span></span></code></pre></div><p>运行后输出 xxx_bindings_generated.dart 为 dart 下的绑定，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initialize_dart_api</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ffi</span><span class="p">.</span><span class="n">Pointer</span><span class="o">&lt;</span><span class="n">ffi</span><span class="p">.</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">api_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dart_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_debug</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_initialize_dart_api</span><span class="p">(</span><span class="n">api_data</span><span class="p">,</span> <span class="n">dart_port</span><span class="p">,</span> <span class="n">is_debug</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="kd">final</span> <span class="n">_initialize_dart_apiPtr</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">_lookup</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ffi</span><span class="p">.</span><span class="n">NativeFunction</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">ffi</span><span class="p">.</span><span class="n">Void</span> <span class="n">Function</span><span class="p">(</span><span class="n">ffi</span><span class="p">.</span><span class="n">Pointer</span><span class="o">&lt;</span><span class="n">ffi</span><span class="p">.</span><span class="n">Void</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ffi</span><span class="p">.</span><span class="n">Int64</span><span class="p">,</span> <span class="n">ffi</span><span class="p">.</span><span class="n">Bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;initialize_dart_api&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="kd">final</span> <span class="n">_initialize_dart_api</span> <span class="o">=</span> <span class="n">_initialize_dart_apiPtr</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">asFunction</span><span class="o">&lt;</span><span class="kt">void</span> <span class="n">Function</span><span class="p">(</span><span class="n">ffi</span><span class="p">.</span><span class="n">Pointer</span><span class="o">&lt;</span><span class="n">ffi</span><span class="p">.</span><span class="n">Void</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span><span class="o">&gt;</span><span class="p">();</span>
</span></span></code></pre></div><p>使用时需要增加动态库加载功能，并且最好是增加一个wapper类封装，类似 Rust 常用的 unsafe 机制。</p>
<p>动态库加载：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">dartffi</span><span class="p">.</span><span class="n">DynamicLibrary</span> <span class="n">_dylib</span> <span class="o">=</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Platform</span><span class="p">.</span><span class="n">isMacOS</span> <span class="o">||</span> <span class="n">Platform</span><span class="p">.</span><span class="n">isIOS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dartffi</span><span class="p">.</span><span class="n">DynamicLibrary</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">$</span><span class="n">_libName</span><span class="s1">.framework/</span><span class="si">$</span><span class="n">_libName</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Platform</span><span class="p">.</span><span class="n">isAndroid</span> <span class="o">||</span> <span class="n">Platform</span><span class="p">.</span><span class="n">isLinux</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dartffi</span><span class="p">.</span><span class="n">DynamicLibrary</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;lib</span><span class="si">$</span><span class="n">_libName</span><span class="s1">.so&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Platform</span><span class="p">.</span><span class="n">isWindows</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dartffi</span><span class="p">.</span><span class="n">DynamicLibrary</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">$</span><span class="n">_libName</span><span class="s1">.dll&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">throw</span> <span class="n">UnsupportedError</span><span class="p">(</span><span class="s1">&#39;Unknown platform: </span><span class="si">${</span><span class="n">Platform</span><span class="p">.</span><span class="n">operatingSystem</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}();</span>
</span></span></code></pre></div><p>wapper类实例化时必须先调用 initialize_dart_api 函数，譬如一个简单的实现, 启动时传入 _receivePort.sendPort.nativePort，然后通过监听 _receivePort 将 Rust 的异步消息以Stream的方式广播出去。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">XXXBindings</span> <span class="n">_xxxBindings</span> <span class="o">=</span> <span class="n">XXXBindings</span><span class="p">(</span><span class="n">_dylib</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">StreamController</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;?</span> <span class="n">_messageController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="n">XXXService</span> <span class="kd">get</span> <span class="n">instance</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_instance</span> <span class="o">??=</span> <span class="n">XXXService</span><span class="p">.</span><span class="n">_internal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_instance</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">XXXService</span><span class="p">.</span><span class="n">_internal</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_receivePort</span> <span class="o">=</span> <span class="n">ReceivePort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_messageController</span> <span class="o">=</span> <span class="n">StreamController</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="p">.</span><span class="n">broadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_engineStartedController</span><span class="o">!</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize the Dart API in the native library
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_xxxBindings</span><span class="p">.</span><span class="n">initialize_dart_api</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">dartffi</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="n">NativeApi</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="n">initializeApiDLData</span><span class="p">,</span> <span class="c1">// API data - pass null from Dart side
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_receivePort</span><span class="p">.</span><span class="n">sendPort</span><span class="p">.</span><span class="n">nativePort</span><span class="p">,</span> <span class="c1">// Native port ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">kDebugMode</span><span class="p">,</span> <span class="c1">// Debug mode flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Start listening to the receive port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_startListening</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_startListening</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_receivePort</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">rawMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_disposed</span> <span class="o">||</span> <span class="n">_messageController</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">rawMessage</span> <span class="k">is</span> <span class="n">Uint8List</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">fbMessage</span> <span class="o">=</span> <span class="n">fb</span><span class="p">.</span><span class="n">Message</span><span class="p">(</span><span class="n">rawMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">fromFlatBuffer</span><span class="p">(</span><span class="n">fbMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// logInfo(&#39;Received message&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_messageController</span><span class="o">!</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logWarning</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;Received unexpected message type: </span><span class="si">${</span><span class="n">rawMessage</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">logWarning</span><span class="p">(</span><span class="s1">&#39;Error processing message: </span><span class="si">$</span><span class="n">e</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">logWarning</span><span class="p">(</span><span class="s1">&#39;Stack trace: </span><span class="si">$</span><span class="n">stackTrace</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Add error to stream instead of silently ignoring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">_messageController</span><span class="o">!</span><span class="p">.</span><span class="n">addError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onError:</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logWarning</span><span class="p">(</span><span class="s1">&#39;ReceivePort error: </span><span class="si">$</span><span class="n">error</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">logWarning</span><span class="p">(</span><span class="s1">&#39;Stack trace: </span><span class="si">$</span><span class="n">stackTrace</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_messageController</span><span class="o">?</span><span class="p">.</span><span class="n">addError</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onDone:</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logInfo</span><span class="p">(</span><span class="s1">&#39;ReceivePort closed&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_messageController</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h2 id="内存管理">内存管理<a hidden class="anchor" aria-hidden="true" href="#内存管理">#</a></h2>
<p>需要注意的是 Rust 下面申请的内存只能 Rust 下释放，Dart 亦同理。</p>
<p>譬如，如果Rust以如下方式返回 CString：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">CString</span>::<span class="n">new</span><span class="p">(</span><span class="n">xxx_string</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">c_string</span><span class="o">|</span><span class="w"> </span><span class="n">c_string</span><span class="p">.</span><span class="n">into_raw</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">())</span><span class="w">
</span></span></span></code></pre></div><p>则需要提供一个接口到 dart，使该字符串使用后能释放：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[unsafe(no_mangle)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&#34;C&#34;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">free_string</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_char</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CString</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>对于 dart 申请的内存，也可以使用类似的机制 ：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">dataPtr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">.</span><span class="n">allocate</span><span class="o">&lt;</span><span class="n">dartffi</span><span class="p">.</span><span class="n">Uint8</span><span class="o">&gt;</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">malloc</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">dataPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://yplam.com/tags/rust/">Rust</a></li>
      <li><a href="https://yplam.com/tags/flutter/">Flutter</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://yplam.com/">YPLAM</a></span> · 

    <a href="https://creativecommons.org/licenses/by-sa/4.0/">
        CC BY-SA 4.0
    </a>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
