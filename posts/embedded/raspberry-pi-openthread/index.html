<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>树莓派 OpenThread 边界路由器配置 | YPLAM</title>
<meta name="keywords" content="OpenThread, Linux, Embedded">
<meta name="description" content="OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。">
<meta name="author" content="">
<link rel="canonical" href="https://yplam.com/posts/embedded/raspberry-pi-openthread/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e9646c1d4a681ebbffe4c0f5bdd79d96646d99daf08cf8a3488605487f2ba1.css" integrity="sha256-RelkbB1KaB67/&#43;TA9b3XnZZkbZna8Iz4o0iGBUh/K6E=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://yplam.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yplam.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yplam.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yplam.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://yplam.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://yplam.com/posts/embedded/raspberry-pi-openthread/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-960JLZS3KY"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-960JLZS3KY');
        }
      </script><meta property="og:url" content="https://yplam.com/posts/embedded/raspberry-pi-openthread/">
  <meta property="og:site_name" content="YPLAM">
  <meta property="og:title" content="树莓派 OpenThread 边界路由器配置">
  <meta property="og:description" content="OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-03-27T00:00:00+00:00">
    <meta property="article:tag" content="OpenThread">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Embedded">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="树莓派 OpenThread 边界路由器配置">
<meta name="twitter:description" content="OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yplam.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "树莓派 OpenThread 边界路由器配置",
      "item": "https://yplam.com/posts/embedded/raspberry-pi-openthread/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "树莓派 OpenThread 边界路由器配置",
  "name": "树莓派 OpenThread 边界路由器配置",
  "description": "OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。\n",
  "keywords": [
    "OpenThread", "Linux", "Embedded"
  ],
  "articleBody": "OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。\nOpenThread 官方提供 Docker、 BeagleBone Black、Raspberry Pi 3B 的支持（代码中 OpenWRT 也是有支持的，只是可能还未正式稳定）。本文将尽量详细地记录 Raspberry Pi 3B 配置成边界路由器的过程。\n树莓派基础配置 第一步当然是下载镜像，并且写入到SD卡。官网地址：https://www.raspberrypi.org/downloads/raspberry-pi-os/ 。Linux系统下可以直接用以下命令写入镜像:\n# 注意：请根据真实情况选择磁盘，不然可能会导致你的数据丢失 sudo dd bs=4M if=2020-08-20-raspios-buster-armhf-lite.img of=/dev/mmcblk0 conv=fsync 启用wifi与ssh 使用headless的配置方式，不需要显示器与外接键盘。在SD卡的 boot 分区中创建一个空的 ssh 文件：\ncd /run/media/yplam/boot touch ssh 在刚刚那个 boot 分区新建一个 wpa_supplicant.conf 文件，输入 WIFI 网络信息：\ncountry=CN ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev update_config=1 network={ ssid=\"NETWORK-NAME\" psk=\"NETWORK-PASSWORD\" } 插入SD卡上电启动，如果有mdns的话直接 ：\nping raspberrypi.local 获取IP，如果没有则登录路由器把它找出来，然后ssh登录，用户名pi，密码 raspberry 。\n基础软件安装 sudo apt install git OTBR编译安装 git clone https://github.com/openthread/ot-br-posix cd ot-br-posix ./script/bootstrap ./script/setup 注意，可能需要改改 script/_dns64 中关于 dns 服务器的配置（国内无法访问）\nRCP 配置 编译 RCP 固件，如 NRF52840 可以使用以下编译选项：\ncd /src/openthread/ ./bootstrap make -f examples/Makefile-nrf52840 BORDER_AGENT=1 BORDER_ROUTER=1 COMMISSIONER=1 UDP_FORWARD=1 USB=1 LINK_RAW=1 BOOTLOADER=USB cd /src/openthread/output/nrf52840/bin arm-none-eabi-objcopy -O ihex ot-rcp ot-rcp.hex 插入 RCP 到树莓派 USB 口，查看：\nls /dev/tty* 名称为 /dev/ttyACM* 的设备即为 RCP；修改配置文件 /etc/default/otbr-agent\nOTBR_AGENT_OPTS=\"-I wpan0 spinel+hdlc+uart:///dev/ttyACM0\" 修改配置后重启系统，运行以下命令：\nsudo systemctl status 如果安装正常，则可以看到相关服务正常运行：\navahi-daemon.service otbr-agent.service otbr-web.service 而运行下面命令可以看到OpenThread网络为 disabled 状态\nsudo ot-ctl state AP模式配置 树莓派可以配置运行在 AP 模式，其他设备可以接入树莓派提供的网络来管理 OpenThread 网络。\n安装以下软件：\nsudo apt-get install hostapd dnsmasq tayga hostapd — 允许使用树莓派的WIFI允许在AP模式 dnsmasq — 提供 DHCP 与 DNS 服务 tayga — NAT64服务，提供外网 IPV4 地址到 IPV6 地址的转换 修改文件 /etc/dhcpcd.conf，末尾增加一行\ndenyinterfaces wlan0 新建文件 /etc/network/interfaces.d/wlan0\nallow-hotplug wlan0 iface wlan0 inet static address 192.168.1.2 netmask 255.255.255.0 network 192.168.1.0 broadcast 192.168.1.255 配置 /etc/hostapd/hostapd.conf，因为使用的是 PI3B+，支持5G网络，配置有所不同\n# The Wi-Fi interface configured for static IPv4 addresses interface=wlan0 # Use the 802.11 Netlink interface driver driver=nl80211 # The user-defined name of the network ssid=BorderRouter-AP # Use the 5GHz band hw_mode=a # Use channel 6 channel=40 # Enable 802.11n ieee80211n=1 # Enable WMM wmm_enabled=1 require_ht=1 ht_capab=[HT40-][DSSS_CCK-40] # Accept all MAC addresses macaddr_acl=0 # Use WPA authentication auth_algs=1 # Require clients to know the network name ignore_broadcast_ssid=0 # Use WPA2 wpa=2 # Use a pre-shared key wpa_key_mgmt=WPA-PSK # The network passphrase wpa_passphrase=12345678 # Use AES, instead of TKIP rsn_pairwise=CCMP 修改 /etc/default/hostapd\nDAEMON_CONF=\"/etc/hostapd/hostapd.conf\" sudo systemctl unmask hostapd sudo systemctl start hostapd 修改 /etc/systemd/system/hostapd.service\n[Unit] Description=Hostapd IEEE 802.11 Access Point After=sys-subsystem-net-devices-wlan0.device BindsTo=sys-subsystem-net-devices-wlan0.device [Service] Type=forking PIDFile=/var/run/hostapd.pid ExecStart=/usr/sbin/hostapd -B /etc/hostapd/hostapd.conf -P /var/run/hostapd.pid [Install] WantedBy=multi-user.target 在 /etc/rc.local 的 exit 0 之前添加\nsudo service hostapd start 重启树莓派，可以看到多了一个名叫 BorderRouter-AP 的 wifi 网络可以加入。\n配置 dnsmasq 修改 /etc/dnsmasq.conf\n# The Wi-Fi interface configured for static IPv4 addresses interface=wlan0 # Explicitly specify the address to listen on listen-address=192.168.1.2 # Bind to the interface to make sure we aren't sending things elsewhere bind-interfaces # Forward DNS requests to the Google DNS server=119.29.29.29 # Don't forward short names domain-needed # Never forward addresses in non-routed address spaces bogus-priv # Assign IP addresses between 192.168.1.50 and 192.168.1.150 with a 12 hour lease time dhcp-range=192.168.1.50,192.168.1.150,12h 修正 /lib/systemd/system/bind9.service 与 dnsmasq 的冲突\nAfter=network.target dnsmasq.service 配置 tayga 修改 /etc/tayga.conf 关于以下配置项\nprefix 64:ff9b::/96 dynamic-pool 192.168.255.0/24 ipv6-addr 2001:db8:1::1 ipv4-addr 192.168.255.1 启用 tayga\nsudo systemctl enable tayga 使能网络转发\nsudo sh -c \"echo 1 \u003e /proc/sys/net/ipv4/ip_forward\" sudo sh -c \"echo 1 \u003e /proc/sys/net/ipv6/conf/all/forwarding\" 为了重启后能生效，修改配置文件 /etc/sysctl.conf，更改对应项配置\n使能 NAT44\nsudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 使能 wlan0 与 eth0 之间的转发\nsudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT 保存iptables配置\nsudo sh -c \"iptables-save \u003e /etc/iptables.ipv4.nat\" 在 /etc/rc.local 的 exit 前增加\niptables-restore \u003c /etc/iptables.ipv4.nat 重启系统，查看各服务是否正常启动，譬如 ping -6 一个外网 IP\nping -6 64:ff9b::*** 创建 OpenThread 网络 sudo ot-ctl panid 0xc80b sudo ot-ctl extpanid f37fcf5bc5cbe195 sudo ot-ctl masterkey e35efdce91b5d2ad6ee96350c31e56d3 sudo ot-ctl pskc 7beafb2ea25f3f8ce244b1e92a79a623 sudo ot-ctl networkname MyOT sudo ot-ctl channel 11 sudo ot-ctl ifconfig up sudo ot-ctl thread start sudo ot-ctl state sudo ot-ctl prefix add fd11:22::/64 pasor sudo ot-ctl netdata register 需要注意的是后面两行如果不运行，OpenThread网络中的设备将无法访问外网。\n至此，OpenThread网络配置完成，可以通过 ping 外网 ip 进行测试（通过nat64）。\n",
  "wordCount" : "562",
  "inLanguage": "zh-cn",
  "datePublished": "2021-03-27T00:00:00Z",
  "dateModified": "2021-03-27T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yplam.com/posts/embedded/raspberry-pi-openthread/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "YPLAM",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yplam.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yplam.com/" title="YPLAM">
                    <span>HOME</span>

                </a>
            </li>
            <li>
                <a href="https://yplam.com/about/" title="关于YPLam">
                    <span>ABOUT</span>

                </a>
            </li>
            <li>
                <a href="https://github.com/yplam" title="GITHUB">
                    <span>GITHUB</span>

                </a>
            </li>
            <li>
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      树莓派 OpenThread 边界路由器配置
    </h1>
    <div class="post-meta"><span title='2021-03-27 00:00:00 +0000 UTC'>2021-03-27</span>

</div>
  </header> 
  <div class="post-content"><p>OpenThread 边界路由器的作用是作为 Thread 网络与其他基于IP的网络（如WIFI、以太网）的桥梁。有了边界路由器的存在才让 Thread 网络中的设备成了跟手机、电脑等对等的一员（是的，基于IP就是那么自信）。</p>
<p>OpenThread 官方提供 Docker、 BeagleBone Black、Raspberry Pi 3B 的支持（代码中 OpenWRT 也是有支持的，只是可能还未正式稳定）。本文将尽量详细地记录 Raspberry Pi 3B 配置成边界路由器的过程。</p>
<h2 id="树莓派基础配置">树莓派基础配置<a hidden class="anchor" aria-hidden="true" href="#树莓派基础配置">#</a></h2>
<p>第一步当然是下载镜像，并且写入到SD卡。官网地址：<a href="https://www.raspberrypi.org/downloads/raspberry-pi-os/">https://www.raspberrypi.org/downloads/raspberry-pi-os/</a> 。Linux系统下可以直接用以下命令写入镜像:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 注意：请根据真实情况选择磁盘，不然可能会导致你的数据丢失</span>
</span></span><span class="line"><span class="cl">sudo dd <span class="nv">bs</span><span class="o">=</span>4M <span class="k">if</span><span class="o">=</span>2020-08-20-raspios-buster-armhf-lite.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">conv</span><span class="o">=</span>fsync
</span></span></code></pre></div><h3 id="启用wifi与ssh">启用wifi与ssh<a hidden class="anchor" aria-hidden="true" href="#启用wifi与ssh">#</a></h3>
<p>使用headless的配置方式，不需要显示器与外接键盘。在SD卡的 boot 分区中创建一个空的 ssh 文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /run/media/yplam/boot
</span></span><span class="line"><span class="cl">touch ssh
</span></span></code></pre></div><p>在刚刚那个 boot 分区新建一个 wpa_supplicant.conf 文件，输入 WIFI 网络信息：</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
    ssid=&#34;NETWORK-NAME&#34;
    psk=&#34;NETWORK-PASSWORD&#34;
}
</code></pre><p>插入SD卡上电启动，如果有mdns的话直接 ：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ping raspberrypi.local
</span></span></code></pre></div><p>获取IP，如果没有则登录路由器把它找出来，然后ssh登录，用户名pi，密码 raspberry 。</p>
<h3 id="基础软件安装">基础软件安装<a hidden class="anchor" aria-hidden="true" href="#基础软件安装">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install git
</span></span></code></pre></div><h2 id="otbr编译安装">OTBR编译安装<a hidden class="anchor" aria-hidden="true" href="#otbr编译安装">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/openthread/ot-br-posix
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ot-br-posix
</span></span><span class="line"><span class="cl">./script/bootstrap
</span></span><span class="line"><span class="cl">./script/setup
</span></span></code></pre></div><p>注意，可能需要改改 script/_dns64 中关于 dns 服务器的配置（国内无法访问）</p>
<h2 id="rcp-配置">RCP 配置<a hidden class="anchor" aria-hidden="true" href="#rcp-配置">#</a></h2>
<p>编译 RCP 固件，如 NRF52840 可以使用以下编译选项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /src/openthread/
</span></span><span class="line"><span class="cl">./bootstrap
</span></span><span class="line"><span class="cl">make -f examples/Makefile-nrf52840 <span class="nv">BORDER_AGENT</span><span class="o">=</span><span class="m">1</span> <span class="nv">BORDER_ROUTER</span><span class="o">=</span><span class="m">1</span> <span class="nv">COMMISSIONER</span><span class="o">=</span><span class="m">1</span> <span class="nv">UDP_FORWARD</span><span class="o">=</span><span class="m">1</span> <span class="nv">USB</span><span class="o">=</span><span class="m">1</span> <span class="nv">LINK_RAW</span><span class="o">=</span><span class="m">1</span> <span class="nv">BOOTLOADER</span><span class="o">=</span>USB
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /src/openthread/output/nrf52840/bin
</span></span><span class="line"><span class="cl">arm-none-eabi-objcopy -O ihex ot-rcp ot-rcp.hex
</span></span></code></pre></div><p>插入 RCP 到树莓派 USB 口，查看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls /dev/tty*
</span></span></code></pre></div><p>名称为 /dev/ttyACM* 的设备即为 RCP；修改配置文件 /etc/default/otbr-agent</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">OTBR_AGENT_OPTS</span><span class="o">=</span><span class="s2">&#34;-I wpan0 spinel+hdlc+uart:///dev/ttyACM0&#34;</span>
</span></span></code></pre></div><p>修改配置后重启系统，运行以下命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl status
</span></span></code></pre></div><p>如果安装正常，则可以看到相关服务正常运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">avahi-daemon.service
</span></span><span class="line"><span class="cl">otbr-agent.service
</span></span><span class="line"><span class="cl">otbr-web.service
</span></span></code></pre></div><p>而运行下面命令可以看到OpenThread网络为 disabled 状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ot-ctl state
</span></span></code></pre></div><h2 id="ap模式配置">AP模式配置<a hidden class="anchor" aria-hidden="true" href="#ap模式配置">#</a></h2>
<p>树莓派可以配置运行在 AP 模式，其他设备可以接入树莓派提供的网络来管理 OpenThread 网络。</p>
<p>安装以下软件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install hostapd dnsmasq tayga
</span></span></code></pre></div><ul>
<li>hostapd — 允许使用树莓派的WIFI允许在AP模式</li>
<li>dnsmasq — 提供 DHCP 与 DNS 服务</li>
<li>tayga — NAT64服务，提供外网 IPV4 地址到 IPV6 地址的转换</li>
</ul>
<p>修改文件 /etc/dhcpcd.conf，末尾增加一行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">denyinterfaces wlan0
</span></span></code></pre></div><p>新建文件 /etc/network/interfaces.d/wlan0</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">allow-hotplug wlan0
</span></span><span class="line"><span class="cl">iface wlan0 inet static
</span></span><span class="line"><span class="cl">    address 192.168.1.2
</span></span><span class="line"><span class="cl">    netmask 255.255.255.0
</span></span><span class="line"><span class="cl">    network 192.168.1.0
</span></span><span class="line"><span class="cl">    broadcast 192.168.1.255
</span></span></code></pre></div><p>配置 /etc/hostapd/hostapd.conf，因为使用的是 PI3B+，支持5G网络，配置有所不同</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># The Wi-Fi interface configured for static IPv4 addresses</span>
</span></span><span class="line"><span class="cl"><span class="nv">interface</span><span class="o">=</span>wlan0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use the 802.11 Netlink interface driver</span>
</span></span><span class="line"><span class="cl"><span class="nv">driver</span><span class="o">=</span>nl80211
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The user-defined name of the network</span>
</span></span><span class="line"><span class="cl"><span class="nv">ssid</span><span class="o">=</span>BorderRouter-AP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use the 5GHz band</span>
</span></span><span class="line"><span class="cl"><span class="nv">hw_mode</span><span class="o">=</span>a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use channel 6</span>
</span></span><span class="line"><span class="cl"><span class="nv">channel</span><span class="o">=</span><span class="m">40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Enable 802.11n</span>
</span></span><span class="line"><span class="cl"><span class="nv">ieee80211n</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Enable WMM</span>
</span></span><span class="line"><span class="cl"><span class="nv">wmm_enabled</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">require_ht</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">ht_capab</span><span class="o">=[</span>HT40-<span class="o">][</span>DSSS_CCK-40<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Accept all MAC addresses</span>
</span></span><span class="line"><span class="cl"><span class="nv">macaddr_acl</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use WPA authentication</span>
</span></span><span class="line"><span class="cl"><span class="nv">auth_algs</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Require clients to know the network name</span>
</span></span><span class="line"><span class="cl"><span class="nv">ignore_broadcast_ssid</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use WPA2</span>
</span></span><span class="line"><span class="cl"><span class="nv">wpa</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use a pre-shared key</span>
</span></span><span class="line"><span class="cl"><span class="nv">wpa_key_mgmt</span><span class="o">=</span>WPA-PSK
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The network passphrase</span>
</span></span><span class="line"><span class="cl"><span class="nv">wpa_passphrase</span><span class="o">=</span><span class="m">12345678</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use AES, instead of TKIP</span>
</span></span><span class="line"><span class="cl"><span class="nv">rsn_pairwise</span><span class="o">=</span>CCMP
</span></span></code></pre></div><p>修改 /etc/default/hostapd</p>
<pre tabindex="0"><code>DAEMON_CONF=&#34;/etc/hostapd/hostapd.conf&#34;
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl unmask hostapd
</span></span><span class="line"><span class="cl">sudo systemctl start hostapd
</span></span></code></pre></div><p>修改 /etc/systemd/system/hostapd.service</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[Unit]</span>
</span></span><span class="line"><span class="cl"><span class="na">Description</span><span class="o">=</span><span class="s">Hostapd IEEE 802.11 Access Point</span>
</span></span><span class="line"><span class="cl"><span class="na">After</span><span class="o">=</span><span class="s">sys-subsystem-net-devices-wlan0.device</span>
</span></span><span class="line"><span class="cl"><span class="na">BindsTo</span><span class="o">=</span><span class="s">sys-subsystem-net-devices-wlan0.device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Service]</span>
</span></span><span class="line"><span class="cl"><span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
</span></span><span class="line"><span class="cl"><span class="na">PIDFile</span><span class="o">=</span><span class="s">/var/run/hostapd.pid</span>
</span></span><span class="line"><span class="cl"><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/sbin/hostapd -B /etc/hostapd/hostapd.conf -P /var/run/hostapd.pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Install]</span>
</span></span><span class="line"><span class="cl"><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></span></code></pre></div><p>在 /etc/rc.local 的 exit 0 之前添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service hostapd start
</span></span></code></pre></div><p>重启树莓派，可以看到多了一个名叫 BorderRouter-AP 的 wifi 网络可以加入。</p>
<h2 id="配置-dnsmasq">配置 dnsmasq<a hidden class="anchor" aria-hidden="true" href="#配置-dnsmasq">#</a></h2>
<p>修改 /etc/dnsmasq.conf</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="c1"># The Wi-Fi interface configured for static IPv4 addresses</span>
</span></span><span class="line"><span class="cl"><span class="na">interface</span><span class="o">=</span><span class="s">wlan0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Explicitly specify the address to listen on</span>
</span></span><span class="line"><span class="cl"><span class="na">listen-address</span><span class="o">=</span><span class="s">192.168.1.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Bind to the interface to make sure we aren&#39;t sending things elsewhere</span>
</span></span><span class="line"><span class="cl"><span class="na">bind-interfaces</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Forward DNS requests to the Google DNS</span>
</span></span><span class="line"><span class="cl"><span class="na">server</span><span class="o">=</span><span class="s">119.29.29.29</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Don&#39;t forward short names</span>
</span></span><span class="line"><span class="cl"><span class="na">domain-needed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Never forward addresses in non-routed address spaces</span>
</span></span><span class="line"><span class="cl"><span class="na">bogus-priv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Assign IP addresses between 192.168.1.50 and 192.168.1.150 with a 12 hour lease time</span>
</span></span><span class="line"><span class="cl"><span class="na">dhcp-range</span><span class="o">=</span><span class="s">192.168.1.50,192.168.1.150,12h</span>
</span></span></code></pre></div><p>修正 /lib/systemd/system/bind9.service 与 dnsmasq 的冲突</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">After</span><span class="o">=</span><span class="s">network.target dnsmasq.service</span>
</span></span></code></pre></div><h2 id="配置-tayga">配置 tayga<a hidden class="anchor" aria-hidden="true" href="#配置-tayga">#</a></h2>
<p>修改 /etc/tayga.conf 关于以下配置项</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">prefix 64:ff9b::/96</span>
</span></span><span class="line"><span class="cl"><span class="na">dynamic-pool 192.168.255.0/24</span>
</span></span><span class="line"><span class="cl"><span class="na">ipv6-addr 2001:db8:1::1</span>
</span></span><span class="line"><span class="cl"><span class="na">ipv4-addr 192.168.255.1</span>
</span></span></code></pre></div><p>启用 tayga</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> tayga
</span></span></code></pre></div><p>使能网络转发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sh -c <span class="s2">&#34;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&#34;</span>
</span></span><span class="line"><span class="cl">sudo sh -c <span class="s2">&#34;echo 1 &gt; /proc/sys/net/ipv6/conf/all/forwarding&#34;</span>
</span></span></code></pre></div><p>为了重启后能生效，修改配置文件 /etc/sysctl.conf，更改对应项配置</p>
<p>使能 NAT44</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span></code></pre></div><p>使能 wlan0 与 eth0 之间的转发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="line"><span class="cl">sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
</span></span></code></pre></div><p>保存iptables配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sh -c <span class="s2">&#34;iptables-save &gt; /etc/iptables.ipv4.nat&#34;</span>
</span></span></code></pre></div><p>在 /etc/rc.local 的 exit 前增加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables-restore &lt; /etc/iptables.ipv4.nat
</span></span></code></pre></div><p>重启系统，查看各服务是否正常启动，譬如 ping -6 一个外网 IP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ping -6 64:ff9b::***
</span></span></code></pre></div><h2 id="创建-openthread-网络">创建 OpenThread 网络<a hidden class="anchor" aria-hidden="true" href="#创建-openthread-网络">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ot-ctl panid 0xc80b
</span></span><span class="line"><span class="cl">sudo ot-ctl extpanid f37fcf5bc5cbe195
</span></span><span class="line"><span class="cl">sudo ot-ctl masterkey e35efdce91b5d2ad6ee96350c31e56d3
</span></span><span class="line"><span class="cl">sudo ot-ctl pskc 7beafb2ea25f3f8ce244b1e92a79a623
</span></span><span class="line"><span class="cl">sudo ot-ctl networkname MyOT
</span></span><span class="line"><span class="cl">sudo ot-ctl channel <span class="m">11</span>
</span></span><span class="line"><span class="cl">sudo ot-ctl ifconfig up
</span></span><span class="line"><span class="cl">sudo ot-ctl thread start
</span></span><span class="line"><span class="cl">sudo ot-ctl state
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ot-ctl prefix add fd11:22::/64 pasor
</span></span><span class="line"><span class="cl">sudo ot-ctl netdata register
</span></span></code></pre></div><p>需要注意的是后面两行如果不运行，OpenThread网络中的设备将无法访问外网。</p>
<p>至此，OpenThread网络配置完成，可以通过 ping 外网 ip 进行测试（通过nat64）。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://yplam.com/tags/openthread/">OpenThread</a></li>
      <li><a href="https://yplam.com/tags/linux/">Linux</a></li>
      <li><a href="https://yplam.com/tags/embedded/">Embedded</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://yplam.com/">YPLAM</a></span> · 

    <a href="https://creativecommons.org/licenses/by-sa/4.0/">
        CC BY-SA 4.0
    </a>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
