<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器 | YPLAM</title>
<meta name="keywords" content="OpenWRT, Linux, Embedded">
<meta name="description" content="最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块，
于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。">
<meta name="author" content="">
<link rel="canonical" href="https://yplam.com/posts/embedded/openwrt-mt7688-4g/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e9646c1d4a681ebbffe4c0f5bdd79d96646d99daf08cf8a3488605487f2ba1.css" integrity="sha256-RelkbB1KaB67/&#43;TA9b3XnZZkbZna8Iz4o0iGBUh/K6E=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://yplam.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yplam.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yplam.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yplam.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://yplam.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://yplam.com/posts/embedded/openwrt-mt7688-4g/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-960JLZS3KY"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-960JLZS3KY');
        }
      </script><meta property="og:url" content="https://yplam.com/posts/embedded/openwrt-mt7688-4g/">
  <meta property="og:site_name" content="YPLAM">
  <meta property="og:title" content="基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器">
  <meta property="og:description" content="最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块， 于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-08-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-08-02T00:00:00+00:00">
    <meta property="article:tag" content="OpenWRT">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Embedded">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器">
<meta name="twitter:description" content="最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块，
于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yplam.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器",
      "item": "https://yplam.com/posts/embedded/openwrt-mt7688-4g/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器",
  "name": "基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器",
  "description": "最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块， 于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。\n",
  "keywords": [
    "OpenWRT", "Linux", "Embedded"
  ],
  "articleBody": "最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块， 于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。\nMT7688 路由板为 5V 供电，核心板 8MB Flash，64MB RAM（怪不得这么便宜，低配中的底配），MPS 两路 DCDC 供电， SIM 卡连 ESD 器件都省了；\n硬件不需要太多改动，只是加了个金升阳的12V转5V DCDC 模块，找个外壳装起来，热融胶固定，钻空加电源座、天线座；完工。\n国内网上资料多是基于 Openwrt 15 的版本，使用官方驱动，不过实在是有点旧了，并且查了一下开源的 MT76 WIFI 驱动感觉也足够稳定，于是决定使用最新的 19.07 版本。\n新版有个好处就是内核比较新，已经自带 EC20 驱动，并且提供 qmi 网卡支持。\n使用 mwan3 实现有线与4G网络的切换。\n项目相关代码脚本位于 https://github.com/yplam/openwrt-mt7688-4g\n编译 编译环境基于 docker 与 docker-compose；\n下载代码\ngit clone https://github.com/yplam/openwrt-mt7688-4g.git cd openwrt-mt7688-4g git submodule update --init 或者手动下载 openwrt 源码到 /src/openwrt 目录（只在 openwrt 19.07 下测试过）\n本机安装好docker与docker-compose, 运行\ndocker-compose up --build 启动编译环境。\n然后运行：\ndocker-compose exec -u docker compiler /bin/bash 进入编译环境；\n因为OpenWRT并不支持我们的核心板，需要对设备树进行修改，为了方便直接基于 LINKIT7688 进行小改；\n修改 openwrt/target/linux/ramips/dts/LINKIT7688.dts，包括内存大小，Flash大小，console 串口\nchosen { bootargs = \"console=ttyS0,57600\"; }; memory@0 { device_type = \"memory\"; reg = \u003c0x0 0x4000000\u003e; }; partition@50000 { compatible = \"denx,uimage\"; label = \"firmware\"; reg = \u003c0x50000 0x7b0000\u003e; }; 为了提升代码下载速度，需要本机的 8123 端口提供 http 代理，如果没有，请修改 docker-compose.yml，删除运行环境相关代码，并且重启 docker-compose;\n运行：\ncd /src/openwrt ./scripts/feeds update -a ./scripts/feeds install -a make menuconfig 选择\nMediaTek Ralink MIPS\nMT76x8 based boards\nMediaTek LinkIt Smart 7688\nNetwork -\u003e mt7688-4g\n可以用 make download 下载各包的代码（因为如果网络不通，可能会多次失败）\n运行编译：\nmake V=99 如无意外，编译成功后会生成\nopenwrt-mt7688-4g/src/openwrt/bin/targets/ramips/mt76x8/openwrt-ramips-mt76x8-LinkIt7688-squashfs-sysupgrade.bin 文件；可以选择在原固件的管理界面直接上传升级，或者通过 uboot 使用 tftp 升级（需要配置tftp服务器，以及配置主机IP）\n完成！\n编译出来的路由器固件相关信息：\n路由器默认IP为 192.16.0.1 WIFI SSID 为 ot4g 密码 12345678 默认 root 用户密码为空，请登录后设置 有线网卡默认为dhcp client的方式获取IP 如果同时接入有线网与4G，将优先使用有线网，如果有线网断开，将切换到4G MT7688 问题与解决 网口切换到GPIO模式 MT7688 官方提供 mt7688_pinmux 工具来查看与配置 GPIO 模式，然而对于网口1-4却不起作用，表现出来是电压为 1.6V 左右， 无法通过 gpioset 与 gpioget 命令读写。\n解决方案参考数据手册 P59，通过配置 1000003C AGPIO_CFG 寄存器的 20:17 位设置为 1 来将该 4 个网口设置成数字引脚。\ndevmem 0x1000003c 32 # 0x00E001FF devmem 0x1000003c 32 0x00FE01FF 然后就可以用 gpioset/gpioget 进行配置：\ngpioget 0 14 # 1 gpioset 0 14=0 watchdog 功能怎么用 使用以下命令查看 watchdog 状态\nubus call system watchdog 输出\n{ \"status\": \"running\", \"timeout\": 30, \"frequency\": 5, \"magicclose\": false } 使用以下命令关闭喂狗，强制看门狗超时：\nubus call system watchdog '{\"stop\": true}' *********************** Watchdog Reset Occurred *********************** ",
  "wordCount" : "260",
  "inLanguage": "zh-cn",
  "datePublished": "2020-08-02T00:00:00Z",
  "dateModified": "2020-08-02T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yplam.com/posts/embedded/openwrt-mt7688-4g/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "YPLAM",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yplam.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yplam.com/" title="YPLAM">
                    <span>HOME</span>

                </a>
            </li>
            <li>
                <a href="https://yplam.com/about/" title="关于YPLam">
                    <span>ABOUT</span>

                </a>
            </li>
            <li>
                <a href="https://github.com/yplam" title="GITHUB">
                    <span>GITHUB</span>

                </a>
            </li>
            <li>
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      基于 OpenWRT 与 MT7688 DIY 4G WIFI 路由器
    </h1>
    <div class="post-meta"><span title='2020-08-02 00:00:00 +0000 UTC'>2020-08-02</span>

</div>
  </header> 
  <div class="post-content"><p>最近经常要到一些没有有线网络的地方，虽然手机可以共享WIFI出来，但总不能24小时开着，刚好手上空闲着一块 EC20 4G 模块，
于是淘宝弄了块最便宜的 MT7688 4G 路由板回来，DIY 自己的 4G WIFI共享路由器。</p>
<p>MT7688 路由板为 5V 供电，核心板 8MB Flash，64MB RAM（怪不得这么便宜，低配中的底配），MPS 两路 DCDC 供电，
SIM 卡连 ESD 器件都省了；</p>
<p>硬件不需要太多改动，只是加了个金升阳的12V转5V DCDC 模块，找个外壳装起来，热融胶固定，钻空加电源座、天线座；完工。</p>
<p>国内网上资料多是基于 Openwrt 15 的版本，使用官方驱动，不过实在是有点旧了，并且查了一下开源的 MT76 WIFI 驱动感觉也足够稳定，于是决定使用最新的 19.07 版本。</p>
<p>新版有个好处就是内核比较新，已经自带 EC20 驱动，并且提供 qmi 网卡支持。</p>
<p>使用 mwan3 实现有线与4G网络的切换。</p>
<p>项目相关代码脚本位于 <a href="https://github.com/yplam/openwrt-mt7688-4g">https://github.com/yplam/openwrt-mt7688-4g</a></p>
<h2 id="编译">编译<a hidden class="anchor" aria-hidden="true" href="#编译">#</a></h2>
<p>编译环境基于 docker 与 docker-compose；</p>
<p>下载代码</p>
<pre tabindex="0"><code>git clone https://github.com/yplam/openwrt-mt7688-4g.git
cd openwrt-mt7688-4g
git submodule update --init
</code></pre><p>或者手动下载 openwrt 源码到 /src/openwrt 目录（只在 openwrt 19.07 下测试过）</p>
<p>本机安装好docker与docker-compose, 运行</p>
<pre tabindex="0"><code>docker-compose up --build
</code></pre><p>启动编译环境。</p>
<p>然后运行：</p>
<pre tabindex="0"><code>docker-compose exec -u docker compiler /bin/bash
</code></pre><p>进入编译环境；</p>
<p>因为OpenWRT并不支持我们的核心板，需要对设备树进行修改，为了方便直接基于 LINKIT7688 进行小改；</p>
<p>修改 openwrt/target/linux/ramips/dts/LINKIT7688.dts，包括内存大小，Flash大小，console 串口</p>
<pre tabindex="0"><code>  chosen {
		bootargs = &#34;console=ttyS0,57600&#34;;
	};

	memory@0 {
		device_type = &#34;memory&#34;;
		reg = &lt;0x0 0x4000000&gt;;
	};
</code></pre><pre tabindex="0"><code>      partition@50000 {
				compatible = &#34;denx,uimage&#34;;
				label = &#34;firmware&#34;;
				reg = &lt;0x50000 0x7b0000&gt;;
			};
</code></pre><p>为了提升代码下载速度，需要本机的 8123 端口提供 http 代理，如果没有，请修改 docker-compose.yml，删除运行环境相关代码，并且重启 docker-compose;</p>
<p>运行：</p>
<pre tabindex="0"><code>cd /src/openwrt
./scripts/feeds update -a
./scripts/feeds install -a
make menuconfig
</code></pre><p>选择</p>
<p>MediaTek Ralink MIPS</p>
<p>MT76x8 based boards</p>
<p>MediaTek LinkIt Smart 7688</p>
<p>Network -&gt; mt7688-4g</p>
<p>可以用 make download 下载各包的代码（因为如果网络不通，可能会多次失败）</p>
<p>运行编译：</p>
<pre tabindex="0"><code>make V=99
</code></pre><p>如无意外，编译成功后会生成</p>
<pre tabindex="0"><code>openwrt-mt7688-4g/src/openwrt/bin/targets/ramips/mt76x8/openwrt-ramips-mt76x8-LinkIt7688-squashfs-sysupgrade.bin
</code></pre><p>文件；可以选择在原固件的管理界面直接上传升级，或者通过 uboot 使用 tftp 升级（需要配置tftp服务器，以及配置主机IP）</p>
<p>完成！</p>
<p>编译出来的路由器固件相关信息：</p>
<ul>
<li>路由器默认IP为 192.16.0.1</li>
<li>WIFI SSID 为 ot4g 密码 12345678</li>
<li>默认 root 用户密码为空，请登录后设置</li>
<li>有线网卡默认为dhcp client的方式获取IP</li>
<li>如果同时接入有线网与4G，将优先使用有线网，如果有线网断开，将切换到4G</li>
</ul>
<h2 id="mt7688-问题与解决">MT7688 问题与解决<a hidden class="anchor" aria-hidden="true" href="#mt7688-问题与解决">#</a></h2>
<h3 id="网口切换到gpio模式">网口切换到GPIO模式<a hidden class="anchor" aria-hidden="true" href="#网口切换到gpio模式">#</a></h3>
<p>MT7688 官方提供 mt7688_pinmux 工具来查看与配置 GPIO 模式，然而对于网口1-4却不起作用，表现出来是电压为 1.6V 左右，
无法通过 gpioset 与 gpioget 命令读写。</p>
<p>解决方案参考数据手册 P59，通过配置 1000003C AGPIO_CFG 寄存器的 20:17 位设置为 1 来将该 4 个网口设置成数字引脚。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">devmem 0x1000003c <span class="m">32</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0x00E001FF</span>
</span></span><span class="line"><span class="cl">devmem 0x1000003c <span class="m">32</span> 0x00FE01FF
</span></span></code></pre></div><p>然后就可以用 gpioset/gpioget 进行配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gpioget <span class="m">0</span> <span class="m">14</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1</span>
</span></span><span class="line"><span class="cl">gpioset <span class="m">0</span> <span class="nv">14</span><span class="o">=</span><span class="m">0</span>
</span></span></code></pre></div><h3 id="watchdog-功能怎么用">watchdog 功能怎么用<a hidden class="anchor" aria-hidden="true" href="#watchdog-功能怎么用">#</a></h3>
<p>使用以下命令查看 watchdog 状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ubus call system watchdog
</span></span></code></pre></div><p>输出</p>
<pre tabindex="0"><code>{
        &#34;status&#34;: &#34;running&#34;,
        &#34;timeout&#34;: 30,
        &#34;frequency&#34;: 5,
        &#34;magicclose&#34;: false
}
</code></pre><p>使用以下命令关闭喂狗，强制看门狗超时：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ubus call system watchdog <span class="s1">&#39;{&#34;stop&#34;: true}&#39;</span>
</span></span></code></pre></div><pre tabindex="0"><code>***********************
Watchdog Reset Occurred
***********************
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://yplam.com/tags/openwrt/">OpenWRT</a></li>
      <li><a href="https://yplam.com/tags/linux/">Linux</a></li>
      <li><a href="https://yplam.com/tags/embedded/">Embedded</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://yplam.com/">YPLAM</a></span> · 

    <a href="https://creativecommons.org/licenses/by-sa/4.0/">
        CC BY-SA 4.0
    </a>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
